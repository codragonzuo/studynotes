
## 小红书：创业公司如何落地容器化镜像部署

https://www.jianshu.com/p/5f5a2223cc2d

容器化部署：  
（1）pipeline部署  
（2）反向代理自动熔断  
（3）

我们一开始就考虑到容器化，一开始就是用 Kubernetes 的框架做容器化的管理。为什么是容器化？因为容器和微服务是一对“好朋友”，从开发环境到线上环境可以做到基本一致；
为什么用 Kubernetes？这和运行环境和部署环境有关系，我们是腾讯云的重度用户，腾讯云有对 Kubernetes提供了非常到位的原生支持，所谓原生支持是指它有几个方面的实现：
第一个是网络层面，我们知道 Kubernetes 在裸金属的环境下，要实现 Overlay 网络，或者有 SDN 网络的环境，而在腾讯云的环境里，它本身就是软件定义网络，所以它在网络上的实现可以做到在容器环境里和原生的网络一样的快，没有任何的性能牺牲。第二在腾讯云的环境里，负载均衡器和 Kubernetes 里的 service 可以捆绑，可以通过创建 Kubernetes 的 service 去维护云服务的 L4 负载均衡器。
第三就是腾讯云的网盘可以被 Kubernetes 管理，实现 PVC 等，当然 Kubernetes 本身提供的特性是足够满足我们的需求的。

- Splinnaker

Spinnaker，它是一个开源项目，是 Netflix 的开源项目。Netflix 的开源项目在社区一直有着不错的口碑。它有开放式的集成能力，它原生就可以支持 Jenkins、GitLab 的整合，它还支持 Webhook，就是说在某一个环境里，如果后面的某个资源的控制组件，本身是个 API，那它就很容易整合到 Spinnaker 里。

再者它有比较强的 Pipeline 的能力，它的 Pipeline 可以复杂非常复杂，Pipeline 之间还可以关联，它还有很强的表达式功能，可以在任何的环节里用表达式来替代静态参数和值，在 Pipeline 开始的时候，生成的过程变量都可以被 Pipeline 每个 stage 调用。比如说这个 Pipeline 是什么时候开始的，触发时的参数是什么，某一个步骤是成功还是失败了，此次要部署的镜像是什么，线上目前是什么版本，这些都可以通过变量访问到。它还有一个比较友好的操作界面，重点的是支持多种云平台。目前支持 Kubernetes、OpenStack、亚马逊的容器云平台。


- Traefik

配置热加载，无需重启

自带熔断功能

－traefik.backend.circuitbreaker:NetworkErrorRatio() > 0.5

动态权重的轮询策略

－traefik.backend.loadbalancer.method:drr

为什么我们用 Traefik 而不用 Nginx 做反向代理呢？首先 Traefik 是一个配置热加载，用 Nginx 时更新路由规则则是做后端服务器的上线、下线都需要重载，但 Traefik 不需要。Traefik 自带熔断功能，可以定义后端某个实例错误率超过比如 50% 的时候，主动熔断它，请求再也不发给它了。还有动态的负载均衡策略，它会记录 5 秒钟之内所有后端实例对请求的响应时间或连接数，如果某个后端实例响应特别慢，那接下来的 5 秒钟就会将这个后端的权重降低直到它恢复到正常性能，这个过程是在不断的调整中，这是我们需要的功能。因为上了容器之后，我们很难保证一个应用的所有实例都部署在相同处理能力的节点上，云服务商采购服务器也是按批量来的，每一批不可能完全一致，很难去保证所有的节点性能都是一致的。
